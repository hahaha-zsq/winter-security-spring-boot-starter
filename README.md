# Winter Security Spring Boot Starter

<div align="center">

[![Maven Central](https://img.shields.io/maven-central/v/io.github.hahaha-zsq/winter-security-spring-boot-starter.svg)](https://search.maven.org/artifact/io.github.hahaha-zsq/winter-security-spring-boot-starter)
[![License](https://img.shields.io/badge/License-Apache%202.0-blue.svg)](https://opensource.org/licenses/Apache-2.0)
[![Spring Boot](https://img.shields.io/badge/Spring%20Boot-2.6.11-brightgreen.svg)](https://spring.io/projects/spring-boot)
[![Java](https://img.shields.io/badge/Java-1.8+-orange.svg)](https://www.oracle.com/java/)

ä¸€ä¸ªå¼€ç®±å³ç”¨çš„ Spring Boot å®‰å…¨è®¤è¯å¯åŠ¨å™¨ï¼Œæ”¯æŒ JWT è®¤è¯å’Œå¾®æœåŠ¡ç½‘å…³é›†æˆ

[å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹) â€¢ [åŠŸèƒ½ç‰¹æ€§](#åŠŸèƒ½ç‰¹æ€§) â€¢ [ä½¿ç”¨æ–‡æ¡£](#ä½¿ç”¨æ–‡æ¡£) â€¢ [ç¤ºä¾‹ä»£ç ](#ç¤ºä¾‹ä»£ç )

</div>

---

## ğŸ“– é¡¹ç›®ç®€ä»‹

**Winter Security Spring Boot Starter** æ˜¯ä¸€ä¸ªè½»é‡çº§ã€é«˜æ€§èƒ½çš„ Spring Security è®¤è¯æˆæƒè§£å†³æ–¹æ¡ˆï¼Œä¸“ä¸ºå¾®æœåŠ¡æ¶æ„è®¾è®¡ã€‚å®ƒæä¾›äº†å¼€ç®±å³ç”¨çš„ JWT è®¤è¯åŠŸèƒ½ï¼Œæ”¯æŒç½‘å…³ç»Ÿä¸€è®¤è¯å’ŒæœåŠ¡ç›´è¿è®¤è¯ä¸¤ç§æ¨¡å¼ï¼Œè®©å¼€å‘è€…æ— éœ€å…³å¿ƒå¤æ‚çš„å®‰å…¨é…ç½®ï¼Œä¸“æ³¨äºä¸šåŠ¡å¼€å‘ã€‚

### ğŸ¯ è§£å†³çš„é—®é¢˜

åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œå®‰å…¨è®¤è¯é¢ä¸´ä»¥ä¸‹æŒ‘æˆ˜ï¼š

- **é‡å¤é…ç½®**ï¼šæ¯ä¸ªå¾®æœåŠ¡éƒ½éœ€è¦é…ç½®ç›¸ä¼¼çš„ Spring Security ä»£ç 
- **ç½‘å…³é›†æˆ**ï¼šç½‘å…³è®¤è¯åï¼Œä¸‹æ¸¸æœåŠ¡å¦‚ä½•è·å–ç”¨æˆ·ä¿¡æ¯
- **ç›´è¿è®¿é—®**ï¼šå¼€å‘è°ƒè¯•æ—¶ï¼Œå¦‚ä½•ç»•è¿‡ç½‘å…³ç›´æ¥è®¿é—®æœåŠ¡
- **ä¸Šä¸‹æ–‡ä¼ é€’**ï¼šå¼‚æ­¥ä»»åŠ¡å’Œçº¿ç¨‹æ± åœºæ™¯ä¸‹ï¼Œç”¨æˆ·ä¿¡æ¯å¦‚ä½•ä¼ é€’
- **æƒé™æ§åˆ¶**ï¼šå¦‚ä½•ä¼˜é›…åœ°å®ç°æ–¹æ³•çº§æƒé™æ ¡éªŒ

æœ¬é¡¹ç›®é€šè¿‡ Spring Boot Starter æœºåˆ¶ï¼Œæä¾›ç»Ÿä¸€çš„è§£å†³æ–¹æ¡ˆï¼Œè®©è¿™äº›é—®é¢˜è¿åˆƒè€Œè§£ã€‚

---

## âœ¨ åŠŸèƒ½ç‰¹æ€§

### ğŸ” åŒè·¯å¾„è®¤è¯

- **ç½‘å…³è®¤è¯æ¨¡å¼**ï¼šä» HTTP è¯·æ±‚å¤´è·å–ç½‘å…³ä¼ é€’çš„ç”¨æˆ·ä¿¡æ¯ï¼ˆæ¨èç”Ÿäº§ç¯å¢ƒï¼‰
- **JWT ç›´è¿æ¨¡å¼**ï¼šè§£æ JWT Token è¿›è¡Œèº«ä»½éªŒè¯ï¼ˆé€‚åˆå¼€å‘è°ƒè¯•ï¼‰
- è‡ªåŠ¨è¯†åˆ«è®¤è¯æ–¹å¼ï¼Œæ— éœ€æ‰‹åŠ¨åˆ‡æ¢

### ğŸš€ å¼€ç®±å³ç”¨

- é›¶é…ç½®å¯åŠ¨ï¼Œå¼•å…¥ä¾èµ–å³å¯ä½¿ç”¨
- è‡ªåŠ¨è£…é… Spring Security é…ç½®
- å†…ç½®åˆç†çš„é»˜è®¤ç™½åå•ï¼ˆå¥åº·æ£€æŸ¥ã€é™æ€èµ„æºã€API æ–‡æ¡£ç­‰ï¼‰
- æ”¯æŒè‡ªå®šä¹‰é…ç½®è¦†ç›–

### ğŸ§µ è·¨çº¿ç¨‹ä¸Šä¸‹æ–‡

- åŸºäºé˜¿é‡Œ TTLï¼ˆTransmittableThreadLocalï¼‰å®ç°
- æ”¯æŒå¼‚æ­¥ä»»åŠ¡ã€çº¿ç¨‹æ± åœºæ™¯ä¸‹çš„ç”¨æˆ·ä¿¡æ¯ä¼ é€’
- è‡ªåŠ¨æ¸…ç†ä¸Šä¸‹æ–‡ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼

### ğŸ¯ æ–¹æ³•çº§æƒé™

- æ”¯æŒ `@PreAuthorize`ã€`@Secured`ã€`@RolesAllowed` æ³¨è§£
- æä¾›ä¾¿æ·çš„æƒé™æ£€æŸ¥å·¥å…·ç±»
- ä¸ Spring Security æ— ç¼é›†æˆ

### ğŸ”§ é«˜åº¦å¯æ‰©å±•

- æä¾› `TokenAuthenticator` æ¥å£ï¼Œæ”¯æŒè‡ªå®šä¹‰ Token éªŒè¯é€»è¾‘
- çµæ´»çš„é…ç½®é¡¹ï¼Œæ»¡è¶³ä¸åŒåœºæ™¯éœ€æ±‚
- æ”¯æŒè‡ªå®šä¹‰ç™½åå•ã€è¯·æ±‚å¤´åç§°ç­‰

---

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### æ ¸å¿ƒæŠ€æœ¯æ ˆ

| æŠ€æœ¯ | ç‰ˆæœ¬ | è¯´æ˜ |
|------|------|------|
| Spring Boot | 2.6.11 | åŸºç¡€æ¡†æ¶ |
| Spring Security | 5.6.x | å®‰å…¨è®¤è¯æ¡†æ¶ |
| Alibaba TTL | 2.14.5 | è·¨çº¿ç¨‹ä¸Šä¸‹æ–‡ä¼ é€’ |
| Lombok | - | ç®€åŒ–ä»£ç  |

### æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      å®¢æˆ·ç«¯è¯·æ±‚                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚      JwtAuthenticationFilter          â”‚
        â”‚   ï¼ˆJWT è®¤è¯è¿‡æ»¤å™¨ - æ ¸å¿ƒå…¥å£ï¼‰         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                       â”‚
                â–¼                       â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   ç½‘å…³è®¤è¯æ¨¡å¼        â”‚   â”‚   JWT ç›´è¿æ¨¡å¼       â”‚
    â”‚ ï¼ˆä»è¯·æ±‚å¤´è·å–ï¼‰      â”‚   â”‚ ï¼ˆè§£æ JWT Tokenï¼‰   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                       â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚    TokenAuthenticator         â”‚
            â”‚  ï¼ˆToken éªŒè¯å™¨ - å¯æ‰©å±•ï¼‰     â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                       â”‚
                â–¼                       â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ SecurityContext     â”‚   â”‚ WinterSecurityContextâ”‚
    â”‚ ï¼ˆSpring Securityï¼‰  â”‚   â”‚ ï¼ˆè‡ªå®šä¹‰ä¸Šä¸‹æ–‡ï¼‰      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚      ä¸šåŠ¡æ–¹æ³•æ‰§è¡Œ              â”‚
            â”‚  ï¼ˆæ”¯æŒ @PreAuthorize ç­‰ï¼‰     â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚      è‡ªåŠ¨æ¸…ç†ä¸Šä¸‹æ–‡            â”‚
            â”‚  ï¼ˆé˜²æ­¢å†…å­˜æ³„æ¼ï¼‰              â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç»„ä»¶

#### 1. JwtAuthenticationFilterï¼ˆè®¤è¯è¿‡æ»¤å™¨ï¼‰
- æ‹¦æˆªæ‰€æœ‰ HTTP è¯·æ±‚
- è¯†åˆ«è®¤è¯æ–¹å¼ï¼ˆç½‘å…³ or JWTï¼‰
- è®¾ç½® Spring Security å’Œè‡ªå®šä¹‰ä¸Šä¸‹æ–‡
- è¯·æ±‚ç»“æŸåè‡ªåŠ¨æ¸…ç†ä¸Šä¸‹æ–‡

#### 2. TokenAuthenticatorï¼ˆToken éªŒè¯å™¨ï¼‰
- æ¥å£è®¾è®¡ï¼Œæ”¯æŒè‡ªå®šä¹‰å®ç°
- è´Ÿè´£ JWT Token çš„è§£æå’ŒéªŒè¯
- è¿”å›ç”¨æˆ·èº«ä»½ä¿¡æ¯

#### 3. WinterSecurityContextHolderï¼ˆä¸Šä¸‹æ–‡æŒæœ‰è€…ï¼‰
- åŸºäº TTL å®ç°è·¨çº¿ç¨‹ä¼ é€’
- æä¾›ä¾¿æ·çš„ç”¨æˆ·ä¿¡æ¯è®¿é—®æ–¹æ³•
- æ”¯æŒè§’è‰²å’Œæƒé™æ£€æŸ¥

#### 4. SecurityAutoConfigurationï¼ˆè‡ªåŠ¨é…ç½®ï¼‰
- Spring Boot è‡ªåŠ¨è£…é…å…¥å£
- æ³¨å†Œæ ¸å¿ƒ Bean
- åŠ è½½é…ç½®å±æ€§

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. æ·»åŠ ä¾èµ–

åœ¨é¡¹ç›®çš„ `pom.xml` ä¸­æ·»åŠ ä¾èµ–ï¼š

```xml
<dependency>
    <groupId>io.github.hahaha-zsq</groupId>
    <artifactId>winter-security-spring-boot-starter</artifactId>
    <version>0.0.1</version>
</dependency>
```

### 2. å®ç° TokenAuthenticator

åˆ›å»ºè‡ªå®šä¹‰çš„ Token éªŒè¯å™¨ï¼ˆç”Ÿäº§ç¯å¢ƒå¿…é¡»ï¼‰ï¼š

```java
@Component
public class JwtTokenAuthenticator implements TokenAuthenticator {
    
    @Autowired
    private AuthService authService; // ä½ çš„è®¤è¯æœåŠ¡
    
    @Override
    public AuthResult authenticate(String token) {
        try {
            // è°ƒç”¨è®¤è¯æœåŠ¡éªŒè¯ Token
            ValidateToken result = authService.validateToken(token);
            
            if (result.getValid()) {
                return AuthResult.success(result);
            } else {
                return AuthResult.failure("Token æ— æ•ˆ");
            }
        } catch (Exception e) {
            return AuthResult.failure("Token éªŒè¯å¤±è´¥: " + e.getMessage());
        }
    }
}
```

### 3. é…ç½®æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰

åœ¨ `application.yml` ä¸­è‡ªå®šä¹‰é…ç½®ï¼š

```yaml
winter:
  security:
    # ç™½åå•é…ç½®
    whitelist:
      urls:
        - /api/public/**
        - /auth/**
        - /actuator/**
    
    # è‡ªå®šä¹‰è¯·æ±‚å¤´åç§°ï¼ˆå¯é€‰ï¼‰
    user-id-header: X-User-Id
    username-header: X-Username
    roles-header: X-User-Roles
    permissions-header: X-User-Permissions
```

### 4. ä½¿ç”¨ç”¨æˆ·ä¿¡æ¯

åœ¨ä¸šåŠ¡ä»£ç ä¸­è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼š

```java
@RestController
@RequestMapping("/api/user")
public class UserController {
    
    @GetMapping("/info")
    public UserInfo getCurrentUser() {
        // æ–¹å¼1ï¼šä½¿ç”¨è‡ªå®šä¹‰ä¸Šä¸‹æ–‡
        String userId = WinterSecurityContextHolder.getUserId();
        String username = WinterSecurityContextHolder.getUsername();
        List<String> roles = WinterSecurityContextHolder.getRoles();
        
        // æ–¹å¼2ï¼šä½¿ç”¨ Spring Security
        Authentication auth = SecurityContextHolder.getContext().getAuthentication();
        CustomUserDetails userDetails = (CustomUserDetails) auth.getPrincipal();
        
        return new UserInfo(userId, username, roles);
    }
    
    // æ–¹æ³•çº§æƒé™æ§åˆ¶
    @PreAuthorize("hasAuthority('user:delete')")
    @DeleteMapping("/{id}")
    public void deleteUser(@PathVariable Long id) {
        // åªæœ‰æ‹¥æœ‰ user:delete æƒé™çš„ç”¨æˆ·æ‰èƒ½è®¿é—®
    }
}
```

---

## ğŸ“š ä½¿ç”¨æ–‡æ¡£

### ç½‘å…³é›†æˆ

ç½‘å…³éœ€è¦åœ¨è¯·æ±‚å¤´ä¸­ä¼ é€’ç”¨æˆ·ä¿¡æ¯ï¼Œæ¨èçš„è¯·æ±‚å¤´ï¼š

| è¯·æ±‚å¤´ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|
| X-User-Id | ç”¨æˆ·å”¯ä¸€æ ‡è¯† | 10001 |
| X-Username | ç”¨æˆ·ç™»å½•å | zhangsan |
| X-User-Roles | ç”¨æˆ·è§’è‰²åˆ—è¡¨ï¼ˆé€—å·åˆ†éš”ï¼‰ | admin,user |
| X-User-Permissions | ç”¨æˆ·æƒé™åˆ—è¡¨ï¼ˆé€—å·åˆ†éš”ï¼‰ | user:read,user:write |

**é‡è¦æç¤º**ï¼šç½‘å…³å¿…é¡»ç§»é™¤å®¢æˆ·ç«¯æ‰‹åŠ¨ä¼ é€’çš„è¿™äº›è¯·æ±‚å¤´ï¼Œé˜²æ­¢ä¼ªé€ èº«ä»½ã€‚

### JWT ç›´è¿è®¤è¯

å¼€å‘è°ƒè¯•æ—¶ï¼Œå¯ä»¥ç›´æ¥æºå¸¦ JWT Token è®¿é—®æœåŠ¡ï¼š

```bash
curl -H "Authorization: Bearer <your-jwt-token>" \
     http://localhost:8080/api/user/info
```

### ç™½åå•é…ç½®

é»˜è®¤ç™½åå•åŒ…æ‹¬ï¼š

- `/actuator/**` - å¥åº·æ£€æŸ¥å’Œç›‘æ§ç«¯ç‚¹
- `/auth/**` - è®¤è¯ç›¸å…³æ¥å£
- `/swagger-ui/**` - API æ–‡æ¡£
- `/error` - é”™è¯¯å¤„ç†

è‡ªå®šä¹‰ç™½åå•ï¼š

```yaml
winter:
  security:
    whitelist:
      urls:
        - /api/public/**
        - /health
        - /info
```

### æƒé™æ§åˆ¶

æ”¯æŒå¤šç§æƒé™æ³¨è§£ï¼š

```java
// 1. @PreAuthorize - æ”¯æŒ SpEL è¡¨è¾¾å¼
@PreAuthorize("hasAuthority('user:delete')")
public void deleteUser(Long id) { }

@PreAuthorize("hasRole('ADMIN')")
public void adminOnly() { }

@PreAuthorize("hasAnyAuthority('user:read', 'user:write')")
public void readOrWrite() { }

// 2. @Secured - ç®€å•è§’è‰²æ£€æŸ¥
@Secured("ROLE_ADMIN")
public void securedMethod() { }

// 3. @RolesAllowed - JSR-250 æ ‡å‡†
@RolesAllowed({"ADMIN", "USER"})
public void jsr250Method() { }
```

### å¼‚æ­¥ä»»åŠ¡æ”¯æŒ

å¾—ç›Šäº TTLï¼Œç”¨æˆ·ä¸Šä¸‹æ–‡å¯ä»¥è‡ªåŠ¨ä¼ é€’åˆ°å¼‚æ­¥ä»»åŠ¡ï¼š

```java
@Service
public class AsyncService {
    
    @Async
    public void asyncTask() {
        // å¼‚æ­¥ä»»åŠ¡ä¸­ä¹Ÿèƒ½è·å–ç”¨æˆ·ä¿¡æ¯
        String userId = WinterSecurityContextHolder.getUserId();
        System.out.println("å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œè€…: " + userId);
    }
}
```

---

## ğŸ’¡ ç¤ºä¾‹ä»£ç 

### å®Œæ•´çš„è®¤è¯æœåŠ¡å®ç°

```java
@Service
public class AuthServiceImpl implements TokenAuthenticator {
    
    @Value("${jwt.secret}")
    private String jwtSecret;
    
    @Autowired
    private UserService userService;
    
    @Override
    public AuthResult authenticate(String token) {
        try {
            // 1. è§£æ JWT Token
            Claims claims = Jwts.parser()
                .setSigningKey(jwtSecret)
                .parseClaimsJws(token)
                .getBody();
            
            // 2. æå–ç”¨æˆ·ä¿¡æ¯
            Long userId = Long.valueOf(claims.getSubject());
            String username = claims.get("username", String.class);
            
            // 3. æŸ¥è¯¢ç”¨æˆ·æƒé™ï¼ˆå¯é€‰ï¼Œä¹Ÿå¯ä»¥ä» Token ä¸­è·å–ï¼‰
            User user = userService.getById(userId);
            
            // 4. æ„é€ éªŒè¯ç»“æœ
            ValidateToken result = new ValidateToken();
            result.setValid(true);
            result.setUserId(userId);
            result.setUserName(username);
            result.setRoles(user.getRoles());
            result.setPermissions(user.getPermissions());
            
            return AuthResult.success(result);
            
        } catch (ExpiredJwtException e) {
            return AuthResult.failure("Token å·²è¿‡æœŸ");
        } catch (Exception e) {
            return AuthResult.failure("Token éªŒè¯å¤±è´¥: " + e.getMessage());
        }
    }
}
```

### ç½‘å…³é…ç½®ç¤ºä¾‹ï¼ˆSpring Cloud Gatewayï¼‰

```java
@Component
public class AuthGatewayFilter implements GlobalFilter, Ordered {
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        // 1. éªŒè¯ Token
        String token = extractToken(exchange.getRequest());
        UserInfo userInfo = validateToken(token);
        
        // 2. æ·»åŠ ç”¨æˆ·ä¿¡æ¯åˆ°è¯·æ±‚å¤´
        ServerHttpRequest request = exchange.getRequest().mutate()
            .header("X-User-Id", userInfo.getUserId().toString())
            .header("X-Username", userInfo.getUsername())
            .header("X-User-Roles", String.join(",", userInfo.getRoles()))
            .header("X-User-Permissions", String.join(",", userInfo.getPermissions()))
            .build();
        
        // 3. ç§»é™¤åŸå§‹ Authorization å¤´ï¼ˆå¯é€‰ï¼‰
        request = request.mutate()
            .headers(headers -> headers.remove("Authorization"))
            .build();
        
        return chain.filter(exchange.mutate().request(request).build());
    }
    
    @Override
    public int getOrder() {
        return -100; // ä¼˜å…ˆçº§
    }
}
```

---

## ğŸ”§ é…ç½®å‚è€ƒ

### å®Œæ•´é…ç½®é¡¹

```yaml
winter:
  security:
    # ç™½åå•é…ç½®
    whitelist:
      urls:
        - /actuator/**
        - /auth/**
        - /swagger-ui/**
    
    # è¯·æ±‚å¤´é…ç½®
    user-id-header: X-User-Id              # ç”¨æˆ·IDè¯·æ±‚å¤´
    username-header: X-Username            # ç”¨æˆ·åè¯·æ±‚å¤´
    roles-header: X-User-Roles             # è§’è‰²è¯·æ±‚å¤´
    permissions-header: X-User-Permissions # æƒé™è¯·æ±‚å¤´
    authorization-header: Authorization    # JWTè®¤è¯å¤´
    bearer-prefix: "Bearer "               # JWTå‰ç¼€
    
    # åˆ†éš”ç¬¦é…ç½®
    gateway-role-and-permission-separator: ","  # è§’è‰²å’Œæƒé™åˆ†éš”ç¬¦
```

---

## ğŸ¤ è´¡çŒ®æŒ‡å—

æ¬¢è¿è´¡çŒ®ä»£ç ã€æå‡ºé—®é¢˜å’Œå»ºè®®ï¼

1. Fork æœ¬ä»“åº“
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯ (`git checkout -b feature/AmazingFeature`)
3. æäº¤æ›´æ”¹ (`git commit -m 'Add some AmazingFeature'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/AmazingFeature`)
5. æäº¤ Pull Request

---

## ğŸ“„ å¼€æºåè®®

æœ¬é¡¹ç›®é‡‡ç”¨ [Apache License 2.0](LICENSE) å¼€æºåè®®ã€‚

---

## ğŸ‘¨â€ğŸ’» ä½œè€…

**dadandiaoming**
- Email: 2595915122@qq.com
- GitHub: [@hahaha-zsq](https://github.com/hahaha-zsq)

---

## â­ Star History

å¦‚æœè¿™ä¸ªé¡¹ç›®å¯¹ä½ æœ‰å¸®åŠ©ï¼Œè¯·ç»™ä¸ª Star â­ï¸ æ”¯æŒä¸€ä¸‹ï¼

---

## ğŸ“® è”ç³»æ–¹å¼

- æäº¤ Issue: [GitHub Issues](https://github.com/hahaha-zsq/winter-security-spring-boot-starter/issues)
- é‚®ä»¶è”ç³»: 2595915122@qq.com

---

<div align="center">

**[â¬† å›åˆ°é¡¶éƒ¨](#winter-security-spring-boot-starter)**

Made with â¤ï¸ by dadandiaoming

</div>
